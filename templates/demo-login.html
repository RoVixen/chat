<!DOCTYPE html> 
<html>
	{% load static %}
	<head>
		<title>Sky Forms Pro</title>
		
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">

		<link rel="stylesheet" href="{% static 'css/demo.css' %}">
		<link rel="stylesheet" href="{% static 'css/font-awesome.css' %}">
		<link rel="stylesheet" href="{% static 'css/sky-forms.css' %}">
		<!--[if lt IE 9]>
			<link rel="stylesheet" href="{% static 'css/sky-forms-ie8.css' %}">
		<![endif]-->

		<script src="{% static 'js/jquery.min.js' %}"></script>
		<script src="{% static 'js/jquery.form.min.js' %}"></script>
		<script src="{% static 'js/jquery.validate.min.js' %}"></script>
		<script src="{% static 'js/jquery.modal.js' %}"></script>
		<script src="http://code.jquery.com/jquery-1.8.3.min.js"></script>

    	<script src="{% static 'jsencrypt-master/bin/jsencrypt.min.js' %}"></script>
		<!--[if lt IE 10]>
			<script src="{% static 'js/jquery.placeholder.min.js' %}"></script>
		<![endif]-->
		<!--[if lt IE 9]>
			<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
			<script src="js/sky-forms-ie8.js"></script>
		<![endif]-->
	</head>
	
	<body class="bg-cyan">
		<div class="body body-s">		
			<form action="#" id="sky-form" class="sky-form" method="post">
				{% csrf_token %}
				<header>Login form</header>
				
				<fieldset>					
					<section>
						<div class="row">
							<label class="label col col-4">E-mail</label>
							<div class="col col-8">
								<label class="input">
									<i class="icon-append fa fa-user"></i>
									<input id="email123" type="email" name="email">
								</label>
							</div>
						</div>
					</section>
					
					<section>
						<div class="row">
							<label class="label col col-4">Password</label>
							<div class="col col-8">
								<label class="input">
									<i class="icon-append fa fa-lock"></i>
									<input id="passl123" type="password" name="password">
								</label>
								<div class="note"><a href="#sky-form2" class="modal-opener">Forgot password?</a></div>
							</div>
						</div>
					</section>
					
					<section>
						<div class="row">
							<div class="col col-4"></div>
							<div class="col col-8">
								<label class="checkbox"><input type="checkbox" name="remember" checked><i></i>Keep me logged in</label>
							</div>
						</div>
					</section>
				</fieldset>
				<footer>
					<button onclick="postDataPost();" type="submit" class="button">Log in</button>
					<a href="#" class="button button-secondary">Register</a>
				</footer>
			</form>			
		</div>
		
		
		
		<form id="sky-form2" class="sky-form sky-form-modal">
			<header>Password recovery</header>

			<fieldset>
				<section>
					<label class="label">E-mail</label>
					<label class="input">
						<i class="icon-append fa fa-envelope-o"></i>
						<input type="email" name="email" id="email">
					</label>
				</section>
			</fieldset>

			<footer>
				<button type="submit" name="submit" class="button">Submit</button>
				<a href="#" class="button button-secondary modal-closer">Close</a>
			</footer>

			<div class="message">
				<i class="fa fa-check"></i>
				<p>Your request successfully sent!<br><a href="#" class="modal-closer">Close window</a></p>
			</div>
		</form>
	</body>
</html>

<script>

	$("#sky-form").submit(function(e) {
		e.preventDefault();
	});

	async function postDataPost() {

		const publicKey = await fetch('http://127.0.0.1:8080/API/SendPublicKey', {
			method: 'GET'
		});

		const contentKey = await publicKey;

		var PublicKey = await contentKey.json();


		 



		var encrypter = new JSEncrypt();

		encrypter.setPublicKey(PublicKey);

		var encrypted = encrypter.encrypt(document.getElementById("passl123").value);

		//console.log(encrypted)

		/*var private = `-----BEGIN PRIVATE KEY-----
						MIICdgIBADANBgkqhkiG9w0BAQEFAASCAmAwggJcAgEAAoGBAKlALWcpygTYJ9ad
						MdUy5Gh58BC6o5DBJ8NhJCemBas+YQZJsh4IGSv7n8g64+5TprW+SYhM1fI0v3yF
						Eo3sPr/ewpZ0n7zx6imGYyIhd5k3pmx2gH/ynluee1wp9aVHbR9RNQijvIHuLSOQ
						fPxjSe9tmXD0WLXS99Ams29nxVUXAgMBAAECgYB1E3XUxO1/yF5WcMqF5fxl4OOV
						TuXSPirZVhsCai/FsxK+nL/fUk7HQ/nVMhd1RtwtIAIRjMT6FE7ZPdwF3IPSabN7
						vFJVZ6crIIM5eQXu9FzpQU0b1na4Py00fpSpT3/g2TVbayF2IoeqcFepVknC/KnQ
						sjOyuAOyy0er6I1U0QJBAM7eCcguG7dD7ETjtQ6y8ACbVm94mYR3UZEXdXTfIdX6
						DIVyhkxF6QfZe8YtUvi0hZ7qUoASTCZum6tGzMVOCp0CQQDRcvgrqJZ0aimPnbSK
						QBH0FQyp4FS6u897gmWP74QbzP5wJ0UuoXNetctdvepHHUuA13QKJ6SS1Bz8NOd7
						NmZDAkAupY7bHtqNFrneRuJ68AqCeISjGjSz1BwGdZ28vtvoXjwYk1yJMnJ7nKT2
						aR3+iuZekUQNMRMOz342vv5Jt3FZAkEAkD5LZ1XNeBL82GlVwrhpJN2yQPO7pnZd
						Z8Pfyga7xqGgwQBqhrityZYNnluCksM8EllPEwdGMdBevdp5aMOIHQJAHgghx7Rz
						MeiEnSPgR4z378QWxzxTD0LjrTSq4Q8XIZUPPl5f18VY03LZqFxAU549u+XzhhrC
						HWYW+cB3h+y62w==
						-----END PRIVATE KEY-----`



		var decrypt = new JSEncrypt();
		decrypt.setPrivateKey(private);
		var uncryptedd = decrypt.decrypt(encrypted);

		console.log(uncryptedd)*/

		const rawResponse = await fetch('http://127.0.0.1:8080/API/login/v1', {
			method: 'POST',
			body: JSON.stringify({user: document.getElementById("email123").value,
								  password: encrypted})
		});

		const content = await rawResponse;

		var data = await content.json();

	  	document.cookie = "token=" + data["token"] + ";path=/";

		if (content.status >= 200 && content.status < 300) {
			window.location.href = '/';
		} else {
			alert("error")
		}
	}

</script>